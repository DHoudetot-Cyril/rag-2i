services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: always
    ports:
      - "6333:6333"
    volumes:
      - ./qdrant_data:/qdrant/storage

  vllm:
    image: vllm/vllm-openai:latest
    container_name: vllm
    restart: always
    runtime: nvidia
    ports:
      - "8080:8000"
    volumes:
      - ./models:/models
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
    ipc: host
    command: --model /models/Qwen3-30B-A3B-Thinking-2507-AWQ --gpu-memory-utilization 0.95 --max-model-len 8192
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]

  rag_api_usagers:
    build:
      context: ./RAG
    container_name: rag_api_usagers
    restart: always
    depends_on:
      - qdrant
      - vllm
    ports:
      - "8000:8000"
    volumes:
      - ./RAG:/app
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_COLLECTION=wiki_usagers
      - LLM_BASE_URL=http://vllm:8000/v1
      - LLM_MODEL_NAME=Qwen/Qwen3-30B-A3B-Thinking-2507-AWQ
    # --- AJOUT CRITIQUE POUR GPU ---
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]

  rag_api_direction:
    build:
      context: ./RAG
    container_name: rag_api_direction
    restart: always
    depends_on:
      - qdrant
      - vllm
    ports:
      - "8001:8000"
    volumes:
      - ./RAG:/app
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_COLLECTION=wiki_direction
      - LLM_BASE_URL=http://vllm:8000/v1
      - LLM_MODEL_NAME=Qwen/Qwen3-30B-A3B-Thinking-2507-AWQ
    # --- AJOUT CRITIQUE POUR GPU ---
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]

  frontend_usagers:
    build:
      context: ./frontend
    container_name: frontend_usagers
    restart: always
    ports:
      - "5173:5173"
    depends_on:
      - rag_api_usagers
    environment:
      - API_TARGET=http://rag_api_usagers:8000

  frontend_direction:
    build:
      context: ./frontend
    container_name: frontend_direction
    restart: always
    ports:
      - "5174:5173"
    depends_on:
      - rag_api_direction
    environment:
      - API_TARGET=http://rag_api_direction:8000
